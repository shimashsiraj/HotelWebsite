@{
    ViewData["Title"] = "Home Page";
}

@model List<Saint.Models.RoomType>


<div class="d-flex justify-content-center align-items-center text-center mb-3">
    <div class="me-3">
        <h2 class="mb-1" style="font-family: 'Lucida Sans', Geneva, Verdana, sans-serif;">
            Welcome to the city of
        </h2>
        <h2 class="mt-0 text-warning" style="font-family: 'Lucida Sans', Geneva, Verdana, sans-serif;">
            Downtown Toronto
        </h2>
    </div>
    <img src="/images/toronto.png" alt="Toronto" style="width: 120px;" />
</div>




<form method="get" asp-action="Index" class="text-center">
    <div class="d-flex justify-content-center gap-4 p-3">
        <!-- Check-In -->
        <div class="d-flex flex-column text-center">
            <label for="checkIn" class="control-label" style="font-family:'Trebuchet MS';">Check-In</label>
            <input id="checkIn" name="checkIn" value="@ViewBag.CheckIn" type="date" class="form-control text-center p-2 rounded-3 bg-light"
                   style="width: 180px; font-family:'Franklin Gothic Medium';" />
        </div>

        <!-- Check-Out -->
        <div class="d-flex flex-column text-center">
            <label for="checkOut" class="control-label" style="font-family:'Trebuchet MS';">Check-Out</label>
            <input id="checkOut" name="checkOut" value="@ViewBag.CheckOut" type="date" class="form-control text-center p-2 rounded-3 bg-light"
                   style="width: 180px; font-family:'Franklin Gothic Medium';" />
        </div>

        <!-- Occupancy (hidden input to hold the number) -->
        <div class="d-flex flex-column text-center">
            <label class="control-label" style="font-family:'Trebuchet MS';">Occupancy</label>
            <button type="button" class="btn btn-outline-secondary rounded-3" style="width: 300px;" data-bs-toggle="modal" data-bs-target="#occupancyModal" id="occupancyDisplay">
                2 Persons
            </button>
            <input type="hidden" id="occupancy" name="occupancy" value="@ViewBag.Occupancy" min="1"/>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Search Rooms</button>
</form>

@if (Model != null && Model.Any())
{
    <h3 class="mt-5">Available Room Types</h3>
    <div class="row">
        @foreach (var rt in Model)
        {
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm">
                    <img src="/images/rooms/@rt.RoomImages" class="card-img-top" alt="@rt.Name" />

                    <div class="card-body">
                        <h5 class="card-title">@rt.Name</h5>
                        <p class="card-text">Capacity: @rt.Capacity</p>
                        <p class="card-text">@rt.Description</p>
                        <a href="@Url.Action("Book", "Booking", new { roomTypeId = rt.Id, checkIn = ViewBag.CheckIn, checkOut = ViewBag.CheckOut })"
                           class="btn btn-primary">Book Now</a>
                    </div>
                </div>
            </div>
        }
    </div>
}
else if (Context.Request.Query.Count > 0)
{
    <p class="text-danger mt-5">No rooms available for your selection.</p>
}



<!-- Modal -->
<div class="modal fade" id="occupancyModal" tabindex="-1" aria-labelledby="occupancyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="occupancyModalLabel">Select Occupancy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <label class="d-block">Adults</label>
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="adjustCount('adults', -1)">−</button>
                        <span id="adults" class="fw-bold fs-5">2</span>
                        <button type="button" class="btn btn-outline-secondary" onclick="adjustCount('adults', 1)">+</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="d-block">Children</label>
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="adjustCount('children', -1)">−</button>
                        <span id="children" class="fw-bold fs-5">0</span>
                        <button type="button" class="btn btn-outline-secondary" onclick="adjustCount('children', 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="updateOccupancy()">Save</button>
            </div>
        </div>
    </div>
</div>


<script>
    const checkInInput = document.getElementById("checkIn");
    const checkOutInput = document.getElementById("checkOut");


    if (!checkInInput.value) {
        const todayDate = new Date();
        todayDate.setMinutes(todayDate.getMinutes() - todayDate.getTimezoneOffset());
        const todayStr = todayDate.toISOString().split("T")[0];
        checkInInput.value = todayStr;
        checkInInput.min = todayStr;
    } else {
        // Ensure min is always at least today
        const minDate = new Date();
        minDate.setMinutes(minDate.getMinutes() - minDate.getTimezoneOffset());
        checkInInput.min = minDate.toISOString().split("T")[0];
    }

    if (!checkOutInput.value) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        checkOutInput.value = tomorrow.toISOString().split("T")[0];
        checkOutInput.min = tomorrow.toISOString().split("T")[0];
    } else {
        const checkInDate = new Date(checkInInput.value);
        const minCheckout = new Date(checkInDate);
        minCheckout.setDate(minCheckout.getDate() + 1);
        checkOutInput.min = minCheckout.toISOString().split("T")[0];
    }


    checkInInput.addEventListener("change", () => {
        const checkInDate = new Date(checkInInput.value);
        const minCheckout = new Date(checkInDate);
        minCheckout.setDate(minCheckout.getDate() + 1);
        const minStr = minCheckout.toISOString().split("T")[0];

        checkOutInput.min = minStr;

        if (new Date(checkOutInput.value) <= checkInDate) {
            checkOutInput.value = minStr;
        }

        updateOccupancy(); 
    });

    checkOutInput.addEventListener("change", () => {
        updateOccupancy(); 
    });


    function updateOccupancy() {
        let adults = parseInt(document.getElementById("adults").textContent);
        const children = parseInt(document.getElementById("children").textContent);
        const occupancy = adults + children;

        document.getElementById("occupancy").value = occupancy;

        const checkInDate = new Date(checkInInput.value);
        const checkOutDate = new Date(checkOutInput.value);
        const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
        const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));

        let label = "";

        if (children > 0) {
            const childLabel = `${children} ${children === 1 ? "Child" : "Children"}`;
            label = `${adults} Adults and ${childLabel} — ${nights} ${nights === 1 ? "Night" : "Nights"}`;
        } else {
            label = `${adults} ${adults === 1 ? "Adult" : "Adults"} — ${nights} ${nights === 1 ? "Night" : "Nights"}`;
        }

        document.getElementById("occupancyDisplay").innerText = label;
    }



    // Initial call
    updateOccupancy();

        function adjustCount(type, change) {
        const maxTotal = 3;

        let adults = parseInt(document.getElementById("adults").textContent);
        let children = parseInt(document.getElementById("children").textContent);

        if (type === "adults") {
            const newCount = adults + change;
            if (newCount >= 1 && newCount + children <= maxTotal) {
                document.getElementById("adults").textContent = newCount;
            }
        } else if (type === "children") {
            const newCount = children + change;
            if (newCount >= 0 && adults + newCount <= maxTotal) {
                document.getElementById("children").textContent = newCount;
            }
        }

        updateOccupancy(); // Reflect change immediately
    }

        if (performance.navigation.type === 1) { // 1 = Reload
        window.location.href = '/Home/Index';
    }

</script>

